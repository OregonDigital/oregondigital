OregonDigital
=============

[![Circle CI](https://circleci.com/gh/OregonDigital/oregondigital.svg?style=svg)](https://circleci.com/gh/OregonDigital/oregondigital)
[![Coverage Status](https://coveralls.io/repos/OregonDigital/oregondigital/badge.png)](https://coveralls.io/r/OregonDigital/oregondigital)
<!--![BrowserStack Status](https://www.browserstack.com/automate/badge.svg?badge_key=<badge_key>)-->

Overview
-----
Current production Oregon Digital running Fedora 3 and Hydra 6.

New development is focused on Oregon Digital 2: http://github.com/OregonDigital/oregondigital_2

Connected projects:
  - [csv2bag](https://github.com/OregonDigital/csv2bag) - bulk ingest from CSV
  - [cdm2bag](https://github.com/OregonDigital/cdm2bag) - bulk ingest from CONTENTdm
  - [ControlledVocabularyManager](https://github.com/OregonDigital/ControlledVocabularyManager) - Rails app with Blazegraph powering [OpaqueNamespace.org](http://opaquenamespace.org/)

<svg id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500.76 164.52">
  <defs>
    <style>
      .cls-1{fill:#fff;}.cls-2{fill:#f5bb60;}.cls-3{fill:#e86f32;}.cls-4{fill:#e53d42;}.cls-5{fill:#bfd141;}.cls-6{fill:#6db64c;}.cls-7{fill:#afdbe7;}.cls-8{fill:#57badf;}.cls-9{fill:#02b2d6;}.cls-10{fill:url(#radial-gradient);}.cls-11{fill:#231f20;}.cls-12{fill:#382f27;}
    </style>
    <radialGradient id="radial-gradient" cx="82.85" cy="73.69" r="16.24" gradientUnits="userSpaceOnUse">
      <stop offset="0" stop-color="#797979"/>
      <stop offset="1" stop-color="#4c4c4c"/>
    </radialGradient>
  </defs>
  <title>
    browserstack
  </title>
  <path class="cls-1" d="M0 0h500.76v164.52H0z"/>
  <circle class="cls-2" cx="82.26" cy="82.26" r="46.15"/>
  <circle class="cls-3" cx="77.61" cy="77.61" r="41.5"/>
  <circle class="cls-4" cx="83.15" cy="72.08" r="35.97"/>
  <circle class="cls-5" cx="86.02" cy="74.96" r="33.09"/>
  <circle class="cls-6" cx="83.59" cy="77.39" r="30.65"/>
  <circle class="cls-7" cx="78.74" cy="72.54" r="25.8"/>
  <circle class="cls-8" cx="82.94" cy="68.33" r="21.59"/>
  <circle class="cls-9" cx="85.57" cy="70.96" r="18.97"/>
  <circle class="cls-10" cx="82.85" cy="73.69" r="16.24"/>
  <circle class="cls-11" cx="82.85" cy="73.69" r="16.24"/>
  <ellipse class="cls-1" cx="53.21" cy="31.67" rx="5.02" ry="3.21" transform="rotate(-65.83 99.172 21.83)"/>
  <path class="cls-12" d="M143.23 64.59a.52.52 0 0 1 .57-.53h14.53c8.27 0 12.17 3.82 12.17 9.61a8 8 0 0 1-4.54 7.65v.11a8.5 8.5 0 0 1 5.23 8.13c0 7.17-4.88 10.62-13.44 10.62h-14a.52.52 0 0 1-.57-.53V64.59zm14.89 14.53c3.45 0 5.57-1.91 5.57-4.73s-2.12-4.78-5.57-4.78h-7.81a.29.29 0 0 0-.34.32v8.87a.29.29 0 0 0 .34.32h7.81zm-7.81 15.56h8.15c3.79 0 5.91-2 5.91-5s-2.12-5-5.91-5h-8.15a.29.29 0 0 0-.34.32v9.4a.29.29 0 0 0 .38.25zm25.65 5.49a.52.52 0 0 1-.57-.53V75.12a.52.52 0 0 1 .57-.53h5.28a.52.52 0 0 1 .57.53v2.18h.06c1.32-2 3.68-3.29 7.18-3.29a8.73 8.73 0 0 1 5.8 2.12c.29.27.34.48.11.74l-3 3.56a.55.55 0 0 1-.8.11 7.91 7.91 0 0 0-4.08-1.22c-3.62 0-5.23 2.39-5.23 6.48v13.84a.52.52 0 0 1-.57.53H176zm20.07-6.48a17.6 17.6 0 0 1-.92-6.32 17.6 17.6 0 0 1 .92-6.32c1.55-4.46 5.8-7.06 11.43-7.06s9.82 2.6 11.37 7.06a17.6 17.6 0 0 1 .92 6.32 17.6 17.6 0 0 1-.92 6.32c-1.55 4.46-5.8 7.06-11.37 7.06s-9.88-2.63-11.43-7.06zm16.6-1.57a13.43 13.43 0 0 0 .57-4.73 13.61 13.61 0 0 0-.57-4.73 5.1 5.1 0 0 0-5.17-3.35 5.18 5.18 0 0 0-5.23 3.35 13.61 13.61 0 0 0-.57 4.73 13.43 13.43 0 0 0 .57 4.73 5.18 5.18 0 0 0 5.23 3.35 5.1 5.1 0 0 0 5.17-3.35zm34.97 8.05a.72.72 0 0 1-.69-.53l-5.34-16.36h-.12l-5.4 16.36a.72.72 0 0 1-.69.53h-4.71a.72.72 0 0 1-.69-.53l-8.72-24.52a.37.37 0 0 1 .4-.53h5.48a.68.68 0 0 1 .75.53l5.34 16.89h.12l5.31-16.89a.79.79 0 0 1 .75-.53h4.13a.79.79 0 0 1 .75.53l5.63 16.89h.11l5.06-16.89a.68.68 0 0 1 .75-.53h5.51a.37.37 0 0 1 .4.53L253 99.66a.72.72 0 0 1-.69.53h-4.71zm15.26-3.45a.49.49 0 0 1 0-.74l3.26-3.19a.59.59 0 0 1 .8 0 13.41 13.41 0 0 0 8.1 2.92c3.39 0 5.11-1.28 5.11-3 0-1.54-1-2.5-4.59-2.81l-3-.27c-5.63-.53-8.5-3.19-8.5-7.54 0-4.94 3.85-8.07 10.74-8.07a17.69 17.69 0 0 1 10.42 3.1.5.5 0 0 1 .12.74l-2.81 3.13a.59.59 0 0 1-.8.11 14.12 14.12 0 0 0-7.24-2.12c-2.76 0-4.19 1.12-4.19 2.66s1 2.39 4.54 2.71l3 .27c5.8.53 8.56 3.29 8.56 7.49 0 5.1-4 8.66-11.6 8.66a18 18 0 0 1-11.92-4.05zm27.89-3.08a18.48 18.48 0 0 1-1-6.27 19 19 0 0 1 .92-6.32c1.55-4.46 5.8-7.06 11.31-7.06 5.69 0 9.82 2.71 11.37 7.06.63 1.81.92 3.56.92 7.7a.54.54 0 0 1-.63.53h-17.03a.29.29 0 0 0-.34.32 5.25 5.25 0 0 0 .4 2c.92 2.5 3.1 3.88 6.2 3.88a8.68 8.68 0 0 0 6.49-2.44.62.62 0 0 1 .86-.11l3.39 2.76a.45.45 0 0 1 .06.74c-2.35 2.55-6.26 4.35-11.37 4.35-5.87-.02-10-2.66-11.55-7.14zm16.71-11.31c-.75-2.07-2.81-3.29-5.4-3.29s-4.71 1.22-5.46 3.29a6 6 0 0 0-.34 2.18.29.29 0 0 0 .34.32h10.85a.29.29 0 0 0 .34-.32 6 6 0 0 0-.33-2.18zm11.6 17.84a.52.52 0 0 1-.57-.53V75.12a.52.52 0 0 1 .57-.53h5.28a.52.52 0 0 1 .57.53v2.18h.06c1.32-2 3.68-3.29 7.18-3.29a8.73 8.73 0 0 1 5.8 2.12c.29.27.34.48.12.74l-3 3.56a.55.55 0 0 1-.8.11 7.9 7.9 0 0 0-4.15-1.24c-3.62 0-5.23 2.39-5.23 6.48v13.86a.52.52 0 0 1-.57.53h-5.28zm19.99-4.19a.55.55 0 0 1-.11-.8l3.56-3.82a.54.54 0 0 1 .8-.05 18.28 18.28 0 0 0 10.63 3.81c4.65 0 7.35-2.18 7.35-5.2 0-2.6-1.72-4.3-7.12-5l-2.04-.25c-7.52-1-11.77-4.3-11.77-10.3 0-6.53 5.17-10.89 13.21-10.89a22.68 22.68 0 0 1 12.56 3.64.46.46 0 0 1 .11.74l-2.76 3.93a.6.6 0 0 1-.8.16 17.41 17.41 0 0 0-9.32-2.83c-4 0-6.14 2-6.14 4.83 0 2.5 1.89 4.2 7.18 4.89l2.06.28c7.52 1 11.66 4.25 11.66 10.46 0 6.43-5 11.21-14.7 11.21-5.74-.03-11.29-2.16-14.36-4.81zm40.96 4.65c-5.57 0-7.7-2.5-7.7-7.49V79.65a.29.29 0 0 0-.34-.32h-1.85a.52.52 0 0 1-.57-.53v-3.56a.52.52 0 0 1 .57-.53h1.84a.29.29 0 0 0 .34-.32v-7a.52.52 0 0 1 .57-.53h5.28a.52.52 0 0 1 .57.53v7a.29.29 0 0 0 .34.32h3.68a.52.52 0 0 1 .57.53v3.56a.52.52 0 0 1-.57.53h-3.62a.29.29 0 0 0-.34.32v13.27c0 1.81.8 2.39 2.58 2.39h1.44a.52.52 0 0 1 .57.53v4.28a.52.52 0 0 1-.57.53h-2.76zm24.35-.46a.52.52 0 0 1-.57-.53v-1.86h-.06c-1.32 1.75-3.91 3-7.81 3-5.05 0-9.3-2.44-9.3-7.81 0-5.58 4.25-8.13 11.08-8.13h5.63a.29.29 0 0 0 .34-.32v-1.23c0-2.92-1.49-4.25-6.14-4.25a10.24 10.24 0 0 0-6.32 1.75.54.54 0 0 1-.8-.11l-2.13-3.51a.47.47 0 0 1 .11-.69c2.24-1.49 5.28-2.5 9.82-2.5 8.44 0 11.54 2.66 11.54 8.92v16.74a.52.52 0 0 1-.57.53h-4.82zm-.69-8.6v-2a.29.29 0 0 0-.34-.32h-4.59c-4.13 0-6 1.06-6 3.45 0 2.12 1.66 3.19 4.77 3.19 3.98.04 6.16-1.4 6.16-4.32zm11.14 2.12a18.72 18.72 0 0 1-.86-6.32 18.72 18.72 0 0 1 .86-6.32c1.61-4.57 5.86-7.06 11.43-7.06a12.48 12.48 0 0 1 9.59 4 .49.49 0 0 1-.06.74l-3.65 2.91a.54.54 0 0 1-.8-.11 6.47 6.47 0 0 0-5.11-2.23 5.07 5.07 0 0 0-5.17 3.35 14 14 0 0 0-.57 4.73 14.31 14.31 0 0 0 .57 4.78 5.09 5.09 0 0 0 5.17 3.29 6.47 6.47 0 0 0 5.11-2.23.54.54 0 0 1 .8-.1l3.65 3a.49.49 0 0 1 .06.74 12.63 12.63 0 0 1-9.59 3.93c-5.57-.03-9.82-2.53-11.43-7.1zm43.44 6.48a1 1 0 0 1-.92-.53l-7-10.73-3.73 4v6.74a.52.52 0 0 1-.57.53h-5.28a.52.52 0 0 1-.57-.53V64.59a.52.52 0 0 1 .57-.53h5.28a.52.52 0 0 1 .57.53v20.82l9.47-10.29a1.34 1.34 0 0 1 1.09-.53h5.86a.3.3 0 0 1 .23.53l-8.79 9.35 10.11 15.19a.32.32 0 0 1-.29.53h-6z"/>
</svg>

Local Development Setup
-----

### Using Docker

#### Grab everything you need

```bash
# Grab the repository
git clone git@github.com:OregonDigital/oregondigital.git

# Start the whole stack - on your first run, this can take a while to download
# all the necessary images
docker-compose up -d
```

#### Generate filler data

First, run the rake task:

    docker-compose exec workers bundle exec rake filler_data

Next, log into the main application by browsing to
`http://localhost:3000/users/sign_in`.  Docker sets up the admin user as
"admin@example.org" with the password "admin123".  Once you're signed in, visit
`http://localhost:3000/resque/overview` and watch the queue slowly get
processed.  This can take a while, but once it's done you should have 3
collections of dummy data.

#### Testing

Easy as `./docker/test.sh`!  Except....

- Want to focus tests?  Just pass in a path: `./docker/test.sh spec/models`.
- If you need to ensure your environment is pristine, use the `--destroy` flag,
  which will destroy and rebuild all containers.
- If you want to keep test containers running to speed up future tests, use the
  `--quick` flag.  This may use up extra resources on your system, but it can
  speed the dev-test loop considerably when isolating tests.

#### Updating Gems

The safest way to update gems is to destroy and rebuild the dev image,
otherwise you're only updating gems within a container, and containers do not
necessarily persist very long.

    docker-compose stop
    docker-compose rm
    docker rmi oregondigital/od1-dev
    docker-compose build workers

You can also run "bundle install" inside a particular container, but this should
only be done if you know what you're doing.  It can get really confusing when you
accidentally use `docker-compose run` when you meant `docker-compose exec`.  Or
if you choose the wrong container name.

#### Various other docker stuff

This list of commands should get you moving forward with most typical
development tasks:

```bash
# When you change code, if you start getting odd errors, you may have to
# restart the OD containers:
docker-compose restart web workers resquehead

# If things are still "weird", rebuild the OD containers:
docker-compose stop web workers resquehead
docker-compose rm web workers resquehead
docker-compose build web workers resquehead
docker-compose up -d

# If you need a "hard reset", nuke it!  WARNING: THIS WILL REMOVE ALL YOUR
# DEVELOPMENT-INGESTED ASSETS!
./docker/nuke.sh

# When nukes just don't destroy enough, try out a SUPERNOVA!  This will remove
# every Docker entity related to OD, which will mean re-downloading the images:
./docker/supernova.sh

# Watch the logs for everything
docker-compose logs -f

# Just watch the Rails web app logs
docker-compose logs -f web
```

### Manual

**Requires Ruby 2.0**

    git clone git@github.com:OregonDigital/oregondigital.git
	cd oregondigital
	bundle install
	rake db:migrate
	git submodule init
	git submodule update
	rake hydra:jetty:config

Symlink media directories:

```bash
ln -s /path/to/rails/media public/media
ln -s /path/to/rails/media/thumbnails public/thumbnails
```

Install memcached if needed, or make sure it's running (needed for login sessions):

* Ubuntu: `sudo apt-get install memcached`
* Mac/Homebrew: `brew install memcached`
* Other: http://memcached.org/downloads

Start the servers:

    rake jetty:start
	rails server

### Vagrant Setup

Requires [Git](http://www.git-scm.com/),
[VirtualBox](https://www.virtualbox.org/), and
[Vagrant](http://www.vagrantup.com/).  Also requires 3 gigs of RAM to be
available for the VM which vagrant creates.

Option 1: manual submodule setup:

    git clone git@github.com:OregonDigital/oregondigital.git
    cd oregondigital
    git submodule init
    git submodule update

Option 2: automatic submodule setup:

    git clone git@github.com:OregonDigital/oregondigital.git --recursive
    cd oregondigital

Either way, you then tell vagrant to download and start the virtual machine:

    vagrant up
    vagrant ssh

After `vagrant ssh` you'll be logged into the VM.  From there, you'll want to
start the Rails server:

    cd /vagrant
    rails server

You can browse the app via `http://localhost:3000`, and check on the jetty
container (which houses solr and fedora) at `http://localhost:8983`.
